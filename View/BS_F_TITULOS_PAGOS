select a.EMPRESA,
       a.ID,
      a.NOME,
      a.SERIE,
      a.TITULO_EXTRATO,
      a.PARCELA,
      a.VENCTO_ORIGINAL,
      a.VENCTO,
      a.DATA_LANCTO,
      a.DATA_TITULO,
      a.LANCTO,
      a.TIPO_LANCTO,
      a.MOEDA,
      a.VALOR_PARCELA,
      a.VALOR_ABERTO,
      a.VALOR_CONTABIL_PARCELA,
      a.VALOR_CONTABIL_ABERTO,
      a.TOTAL_VALOR_IMPOSTOS,
      a.VALOR_LIQUIDO_CONTABIL_ABERTO,
      a.DATA_PAGTO,
      a.REFERENCIA,
      a.STATUS_TITULO,
      a.REF_ORDEM,
      a.CONTA_CONTABIL,
      a.DESC_CONTA,
      a.C_CUSTO,
      a.DESCRICAO_C_CUSTO,
      a.A_FIXO,
      a.DESCRICAO_A_FIXO,
      a.LINHA_SERVICO,
      a.DESC_LINHA_SERVICO,
      a.PROJETO,
      a.DESCRICAO_PROJETO,
      a.CODE_F,
      a.CODE_F_DESCRIPTION,
      a.CODE_G,
      a.CODE_G_DESCRIPTION,
      a.CODE_H,
      a.CODE_H_DESCRIPTION,
      a.CODE_I,
      a.CODE_I_DESCRIPTION,
      a.CODE_J,
      a.CODE_J_DESCRIPTION,
      a.TIPO_TITULO,
      a.STATUS_PARCELA,
      a.CONTRAPARTIDA,
      a.CONTRAPARTIDA_DESC,
      a.GRP_CONTABIL,
      a.DATA_RECEB,
      a.BANCO,
      a.CONTA,
      a.VALOR_PAGO,
      a.DATE_REG AS DATA_REG,
      a.ORIGEM,
      a.REALIZADO

from ifsgft.SPL_supPAYTRANS a

/*SELECT A.COMPANY                                                                                                                                 EMPRESA,
       A.IDENTITY                                                                                                                                ID,
       A.NAME                                                                                                                                    NOME,
       A.LEDGER_ITEM_SERIES_ID                                                                                                                   SERIE,
       a.ledger_item_id                                                                                                                          TITULO_EXTRATO,
       A.INSTALLMENT_ID                                                                                                                          PARCELA,
       (SELECT C.DUE_DATE
          FROM IFSGFT.ABSTRACT_PAYMENT_PLAN2 C
         WHERE C.INVOICE_ID = A.INVOICE_ID
           AND C.INSTALLMENT_ID = A.INSTALLMENT_ID
           AND C.IDENTITY = A.IDENTITY)                                                                                                          VENCTO_ORIGINAL,
       A.DUE_DATE                                                                                                                                VENCTO,
       IFSGFT.INVOICE_API.Get_Voucher_Date_Ref(A.company, A.invoice_id)                                                                          DATA_LANCTO,
       A.LEDGER_DATE                                                                                                                             DATA_TITULO,
       A.VOUCHER_NO_REF                                                                                                                          LANCTO,
       IFSGFT.invoice_API.Get_Voucher_Type_Ref(A.company, A.invoice_id)                                                                          TIPO_LANCTO,
       B.currency                                                                                                                                MOEDA,
       A.INV_AMOUNT                                                                                                                              VALOR_PARCELA,
       A.OPEN_AMOUNT                                                                                                                             VALOR_ABERTO,
       A.INV_DOM_AMOUNT                                                                                                                          VALOR_CONTABIL_PARCELA,
       A.OPEN_DOM_AMOUNT                                                                                                                         VALOR_CONTABIL_ABERTO,
       NVL(B.WITHHELD_TAX_CURR_AMOUNT,0)-NVL(B.WITHHELD_REDUCT_CURR_AMOUNT,0)                                                                    TOTAL_VALOR_IMPOSTOS,
       NVL(ifsgft.PAYMENT_PLAN_API.Get_Open_Dom_Amount(a.company, a.invoice_id, a.installment_id), 0)                                            VALOR_LIQUIDO_CONTABIL_ABERTO,
       B.PAY_DATE                                                                                                                                DATA_PAGTO,
       TO_CHAR(A.invoice_id)                                                                                                                              REFERENCIA,
       A.CLIENT_INV_STATE                                                                                                                        STATUS_TITULO,
       f.ORDER_NO                                                                                                                                REF_ORDEM,
       coalesce(x.account,ifsgft.SPL_cash_flow_util_api.get_code_a_from_inv_id_supp(a.company,a.invoice_id,'%'))                                 CONTA_CONTABIL,


       IFSGFT.ACCOUNT_API.Get_Description(A.company,
       coalesce(x.account,ifsgft.SPL_cash_flow_util_api.get_code_a_from_inv_id_supp(a.company,a.invoice_id,'%')))                                DESC_CONTA,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','B')                                                    C_CUSTO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','B')                                                     DESCRICAO_C_CUSTO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','E')                                                    A_FIXO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','E')                                                     DESCRICAO_A_FIXO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','D')                                                    LINHA_SERVICO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','D')                                                     DESC_LINHA_SERVICO,
       COALESCE(IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','C'),F.PROJECT_ID)                             PROJETO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','C')                                                     DESCRICAO_PROJETO,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','F')                                                    CODE_F,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','F')                                                     CODE_F_DESCRIPTION,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','G')                                                    CODE_G,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','G')                                                     CODE_G_DESCRIPTION,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','H')                                                    CODE_H,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','H')                                                     CODE_H_DESCRIPTION,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','I')                                                    CODE_I,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','I')                                                     CODE_I_DESCRIPTION,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Value_Supp(A.company,A.invoice_id,'%','J')                                                    CODE_J,
       IFSGFT.SPL_cash_flow_util_api.Get_Code_Part_Desc_Supp(A.company,A.invoice_id,'%','J')                                                     CODE_J_DESCRIPTION,
       B.PAYMENT_TYPE_CODE                                                                                                                       TIPO_TITULO,
       IFSGFT.PAYMENT_PLAN_API.Get_State(A.company, A.invoice_id, A.installment_id)                                                              STATUS_PARCELA,
       ifsgft.SPL_cash_flow_util_api.get_code_a_from_inv_id_supp(a.company,
                                                                a.invoice_id,
                                                                'IP1')                                                                           CONTRAPARTIDA,
                ifsgft.account_API.Get_Description( a.company,ifsgft.SPL_cash_flow_util_api.get_code_a_from_inv_id_supp(a.company,
                                                                a.invoice_id,
                                                                'IP1'))                                                                          CONTRAPARTIDA_DESC,
      a.group_id                                                                                                                                 GRP_CONTABIL,
      IFSGFT.invoice_API.Get_Arrival_Date(A.company, A.invoice_id)                                                                               DATA_RECEB,
      g.institute_id                                                                                                                             BANCO,
      G.ACCOUNT_IDENTITY                                                                                                                         CONTA,
      NVL(B.PAID_AMOUNT, 0)\* + NVL(B.INTEREST_CURR_AMOUNT, 0) + NVL(B.FINE_CURR_AMOUNT, 0))*\                                                      VALOR_PAGO,
      B.PAY_DATE                                                                                                                                 DATA_REG,
      'PAGAMENTO REALIZADO'                                                                                                                      ORIGEM,
      NVL(B.PAID_AMOUNT, 0) \*+ NVL(B.INTEREST_CURR_AMOUNT, 0) + NVL(B.FINE_CURR_AMOUNT, 0)) *\                                                     REALIZADO

  FROM IFSGFT.SUPP_INV_INTEREST_FINE_QRY A
  LEFT JOIN IFSGFT.LEDGER_TRANSACTION_SU_QRY B ON (A.COMPANY = B.COMPANY AND A.IDENTITY = B.IDENTITY AND A.PARTY_TYPE_DB = B.PARTY_TYPE_DB AND A.LEDGER_ITEM_ID = B.LEDGER_ITEM_ID AND A.LEDGER_ITEM_SERIES_ID = B.LEDGER_ITEM_SERIES_ID AND A.LEDGER_ITEM_VERSION = B.LEDGER_ITEM_VERSION AND A.INSTALLMENT_ID = B.INSTALLMENT_ID AND B.PAYMENT_TYPE_CODE_DB NOT IN ('COMPSUPPROLLBACK', 'TAXWITHHOLD') AND B.ROLLEDBACK = 'FALSE')
  LEFT JOIN IFSGFT.PAYMENT_WAY_PER_IDENTITY C ON (C.COMPANY = A.COMPANY AND C.IDENTITY = a.IDENTITY AND c.party_type_db = b.party_type_db and C.DEFAULT_PAYMENT_WAY = 'TRUE')
  LEFT JOIN ifsgft.MAN_SUPP_INVOICE e ON e.INVOICE_ID = a.INVOICE_ID
  LEFT JOIN ifsgft.PURCHASE_ORDER f on f.ORDER_NO = e.PO_REF_NUMBER
  LEFT JOIN IFSGFT.CASH_ACCOUNT G ON G.short_name = IFSGFT.PAYMENT_PER_CURRENCY_API.GET_SHORT_NAME(B.COMPANY, B.SERIES_ID, B.PAYMENT_ID, B.CURRENCY)  AND G.company = A.company
  LEFT OUTER JOIN ifsinfo.SPL_RATCONT_MANSUPINV_GRP x     ON     e.company = x.company
                                                  AND    e.identity = x.identity
                                                  AND    e.party_type_db = x.party_type_db
                                                  AND    b.ledger_item_series_id = X.reference_serie
                                                  AND    b.ledger_item_id = X.reference_number
 WHERE (A.INV_AMOUNT <> 0) and B.PAYMENT_TYPE_CODE_db <> 'SUPPOFF'
   AND B.PAY_DATE IS NOT NULL
  -- and A.LEDGER_ITEM_ID  = '1/202313'

union all

SELECT A.COMPANY AS EMPRESA,
       C.IDENTITY AS ID,
       B.TEXT AS NOME,
       C.SERIES_ID AS SERIE,
       A.STATEMENT_NO AS TITULO_EXTRATO,
       1 AS PARCELA,
       A.MIXED_PAYMENT_DATE AS VENCTO_ORIGINAL,
       A.MIXED_PAYMENT_DATE AS VENCTO,
       A.VOUCHER_DATE_REF AS DATA_LANCTO,
       A.MIXED_PAYMENT_DATE AS DATA_TITULO,
       A.VOUCHER_NO_REF AS LANCTO,
       A.VOUCHER_TYPE_REF AS TIPO_LANCTO,
       A.CURRENCY AS MOEDA,
       B.CURR_AMOUNT * -1 AS VALOR_PARCELA,
       0 AS VALOR_ABERTO,
       B.CURR_AMOUNT * -1 AS VALOR_CONTABIL_PARCELA,
       0 AS VALOR_CONTABIL_ABERTO,
       B.VAT_CURR_AMOUNT AS TOTAL_VALOR_IMPOSTOS,
       0 AS VALOR_LIQUIDO_CONTABIL_ABERTO,
       TO_DATE(TO_CHAR(A.MIXED_PAYMENT_DATE, 'DD/MM/RRRR'), 'DD/MM/RRRR') AS DATA_PAGTO,
       'TESOURARIA' AS REFERENCIA,
       A.STATE AS STATUS_TITULO,
       NULL AS REF_ORDEM,
       case when b.MIXED_PAYMENT_TRANS_TYPE = 'Bank Fee Payment' then '5210103003' else C.CODE_A end CONTA_CONTABIL,
       IFSGFT.ACCOUNT_API.Get_Description(A.COMPANY, (case when b.MIXED_PAYMENT_TRANS_TYPE = 'Bank Fee Payment' then '5210103003' else C.CODE_A end)) AS DESC_CONTA,
       C.CODE_B AS C_CUSTO,
       IFSGFT.CODE_B_API.Get_Description(A.COMPANY, C.CODE_B) AS DESCRICAO_C_CUSTO,
       C.CODE_E AS A_FIXO,
       IFSGFT.CODE_E_API.Get_Description(A.COMPANY, C.CODE_E) AS DESCRICAO_A_FIXO,
       C.CODE_D AS LINHA_SERVICO,
       IFSGFT.CODE_D_API.Get_Description(A.COMPANY, C.CODE_D) AS DESC_LINHA_SERVICO,
       C.CODE_C AS PROJETO,
       IFSGFT.ACCOUNTING_PROJECT_API.Get_Description(A.COMPANY, C.CODE_C) AS DESCRICAO_PROJETO,
       C.CODE_F AS CODE_F,
       IFSGFT.CODE_F_API.Get_Description(A.COMPANY, C.CODE_F) AS CODE_F_DESCRIPTION,
       C.CODE_G AS CODE_G,
       IFSGFT.CODE_G_API.Get_Description(A.COMPANY, C.CODE_G) AS CODE_G_DESCRIPTION,
       C.CODE_H AS CODE_H,
       IFSGFT.CODE_H_API.Get_Description(A.COMPANY, C.CODE_H) AS CODE_H_DESCRIPTION,
       C.CODE_I AS CODE_I,
       IFSGFT.CODE_I_API.Get_Description(A.COMPANY, C.CODE_I) AS CODE_I_DESCRIPTION,
       C.CODE_J AS CODE_J,
       IFSGFT.CODE_J_API.Get_Description(A.COMPANY, C.CODE_J) AS CODE_J_DESCRIPTION,
       NULL AS TIPO_TITULO,
       A.STATE AS STATUS_PARCELA,
       IFSGFT.SPL_CASH_FLOW_UTIL_API.Get_Acc_Mix_Pay(A.COMPANY, A.VOUCHER_TYPE_REF, A.VOUCHER_NO_REF, 'PP1') AS CONTRAPARTIDA,
       IFSGFT.ACCOUNT_API.Get_Description(A.COMPANY, IFSGFT.SPL_CASH_FLOW_UTIL_API.Get_Acc_Mix_Pay(A.COMPANY, A.VOUCHER_TYPE_REF, A.VOUCHER_NO_REF, 'PP1')) AS CONTRAPARTIDA_DESC,
       IFSGFT.ACCOUNT_API.Get_Accnt_Group(A.COMPANY, C.CODE_A) AS GRP_CONTABIL,
       A.MIXED_PAYMENT_DATE AS DATA_RECEB,
       G.INSTITUTE_ID AS BANCO,
       G.ACCOUNT_IDENTITY AS CONTA,
       B.CURR_AMOUNT * -1 AS VALOR_PAGO,
       A.MIXED_PAYMENT_DATE AS DATA_REG,
       'PAGAMENTO REALIZADO' AS ORIGEM,
       B.CURR_AMOUNT * -1
FROM IFSGFT.MIXED_PAYMENT A
LEFT JOIN IFSGFT.MIXED_PAYMENT_LUMP_SUM B ON A.COMPANY = B.COMPANY AND A.MIXED_PAYMENT_ID = B.MIXED_PAYMENT_ID
LEFT JOIN IFSGFT.MIXED_PAYMENT_VOUCHER C ON A.COMPANY = C.COMPANY AND C.VOUCHER_NO = A.VOUCHER_NO_REF AND C.VOUCHER_TYPE = A.VOUCHER_TYPE_REF AND C.POSTING_TYPE != 'PP1' and b.CODE_A = c.code_a
LEFT JOIN IFSGFT.CASH_ACCOUNT G ON G.SHORT_NAME = A.SHORT_NAME AND G.COMPANY = A.COMPANY
WHERE A.objSTATE = 'Approved' AND B.MIXED_PAYMENT_TRANS_TYPE_DB IN ('BANKFEEPAYMENT', 'DIRECTCASHPAYMENT') AND B.CURR_AMOUNT < 0
--AND A.STATEMENT_NO = '716'
GROUP BY
       A.COMPANY,
       C.IDENTITY,
       B.TEXT,
       C.SERIES_ID,
       A.STATEMENT_NO,
       A.MIXED_PAYMENT_DATE,
       A.VOUCHER_DATE_REF,
       A.VOUCHER_NO_REF,
       A.VOUCHER_TYPE_REF,
       A.CURRENCY,
       B.CURR_AMOUNT,
       B.VAT_CURR_AMOUNT,
       TO_DATE(TO_CHAR(A.MIXED_PAYMENT_DATE, 'DD/MM/RRRR'), 'DD/MM/RRRR'),
       A.STATE,
       C.CODE_A,
       C.CODE_B,
       C.CODE_E,
       C.CODE_D,
       C.CODE_C,
       C.CODE_F,
       C.CODE_G,
       C.CODE_H,
       C.CODE_I,
       C.CODE_J,
       b.MIXED_PAYMENT_TRANS_TYPE,
       IFSGFT.SPL_CASH_FLOW_UTIL_API.Get_Acc_Mix_Pay(A.COMPANY, A.VOUCHER_TYPE_REF, A.VOUCHER_NO_REF, 'PP1'),
       IFSGFT.ACCOUNT_API.Get_Description(A.COMPANY, IFSGFT.SPL_CASH_FLOW_UTIL_API.Get_Acc_Mix_Pay(A.COMPANY, A.VOUCHER_TYPE_REF, A.VOUCHER_NO_REF, 'PP1')),
       IFSGFT.ACCOUNT_API.Get_Accnt_Group(A.COMPANY, C.CODE_A),
       G.INSTITUTE_ID,
       G.ACCOUNT_IDENTITY*/

    WITH read only
;
